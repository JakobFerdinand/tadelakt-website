---
const { items = [], id = 'lightbox' } = Astro.props;

const itemsId = `${id}-items`;
const outerId = `${id}-outer`;
const imgId = `${id}-image`;
const captionId = `${id}-caption`;
const closeId = `${id}-close`;
const prevId = `${id}-prev`;
const nextId = `${id}-next`;

const itemsJson = JSON.stringify(items ?? []);
---

<div id={outerId} class="ril__outer ril__outer--hidden" aria-hidden="true">
  <div class="ril__backdrop" data-lb-action="close" aria-hidden="true"></div>

  <div
    class="ril__inner"
    role="dialog"
    aria-modal="true"
    aria-label="Image lightbox"
  >
    <div class="ril__toolbar">
      <div class="ril__toolbarSide ril__toolbarSideRight">
        <button
          id={closeId}
          type="button"
          class="ril__toolbarItem ril__builtinButton ril__closeButton"
          aria-label="Close"
        >
          <svg
            class="ril__icon"
            viewBox="0 0 24 24"
            width="24"
            height="24"
            aria-hidden="true"
            focusable="false"
          >
            <path
              fill="currentColor"
              d="M18.3 5.71a1 1 0 0 0-1.41 0L12 10.59 7.11 5.7A1 1 0 0 0 5.7 7.11L10.59 12 5.7 16.89a1 1 0 1 0 1.41 1.41L12 13.41l4.89 4.89a1 1 0 0 0 1.41-1.41L13.41 12l4.89-4.89a1 1 0 0 0 0-1.4z"
            />
          </svg>
        </button>
      </div>
    </div>

    <button
      id={prevId}
      type="button"
      class="ril__navButtonPrev"
      aria-label="Previous image"
    >
      <svg
        class="ril__icon"
        viewBox="0 0 24 24"
        width="26"
        height="26"
        aria-hidden="true"
        focusable="false"
      >
        <path
          fill="currentColor"
          d="M15.41 7.41a1 1 0 0 1 0 1.41L12.24 12l3.17 3.18a1 1 0 1 1-1.41 1.41l-3.88-3.89a1 1 0 0 1 0-1.41L14 7.41a1 1 0 0 1 1.41 0z"
        />
      </svg>
    </button>
    <button
      id={nextId}
      type="button"
      class="ril__navButtonNext"
      aria-label="Next image"
    >
      <svg
        class="ril__icon"
        viewBox="0 0 24 24"
        width="26"
        height="26"
        aria-hidden="true"
        focusable="false"
      >
        <path
          fill="currentColor"
          d="M8.59 16.59a1 1 0 0 1 0-1.41L11.76 12 8.59 8.82a1 1 0 1 1 1.41-1.41l3.88 3.89a1 1 0 0 1 0 1.41L10 16.59a1 1 0 0 1-1.41 0z"
        />
      </svg>
    </button>

    <div class="ril__imageBox">
      <img id={imgId} class="ril__image" src="" alt="" />
    </div>

    <div class="ril__caption ril__caption--hidden">
      <div id={captionId} class="ril__captionContent"></div>
    </div>
  </div>
</div>

<script type="application/json" is:inline id={itemsId} set:html={itemsJson}></script>

<script is:inline>
  (() => {
    const dataEls = document.querySelectorAll('script[type="application/json"][id$="-items"]');
    const suffix = '-items';

    for (const dataEl of dataEls) {
      if (dataEl.dataset.lightboxInitialized === 'true') continue;

      const dataId = dataEl.getAttribute('id') || '';
      if (!dataId.endsWith(suffix)) continue;

      dataEl.dataset.lightboxInitialized = 'true';

      const lightboxId = dataId.slice(0, -suffix.length);

      const outer = document.getElementById(lightboxId + '-outer');
      const imgEl = document.getElementById(lightboxId + '-image');
      const captionContentEl = document.getElementById(lightboxId + '-caption');
      const closeBtn = document.getElementById(lightboxId + '-close');
      const prevBtn = document.getElementById(lightboxId + '-prev');
      const nextBtn = document.getElementById(lightboxId + '-next');

      if (!outer || !imgEl || !captionContentEl || !closeBtn || !prevBtn || !nextBtn) {
        continue;
      }

      const backdrop = outer.querySelector('.ril__backdrop');
      const captionEl = outer.querySelector('.ril__caption');
      if (!backdrop || !captionEl) continue;

      let items = [];
      try {
        items = JSON.parse(dataEl.textContent || '[]') || [];
      } catch {
        items = [];
      }

      let isOpen = false;
      let index = 0;
      let previousBodyOverflow = '';

      const normalizeIndex = (i) => {
        const len = items.length;
        if (!len) return 0;
        return ((i % len) + len) % len;
      };

      const updateNavVisibility = () => {
        const show = items.length > 1;
        prevBtn.style.display = show ? '' : 'none';
        nextBtn.style.display = show ? '' : 'none';
      };

      const setCaption = (item) => {
        captionContentEl.textContent = '';

        const title = (item && item.title) || '';
        const description = (item && item.description) || '';

        if (!title && !description) {
          captionEl.classList.add('ril__caption--hidden');
          return;
        }

        captionEl.classList.remove('ril__caption--hidden');

        if (title) {
          const t = document.createElement('div');
          t.className = 'ril__captionTitle';
          t.textContent = title;
          captionContentEl.appendChild(t);
        }

        if (description) {
          const d = document.createElement('div');
          d.className = 'ril__captionDescription';
          d.textContent = description;
          captionContentEl.appendChild(d);
        }
      };

      const render = () => {
        const item = items[index];
        const src = (item && item.imageUrl) || '';
        const alt = (item && item.title) || '';

        imgEl.src = src;
        imgEl.alt = alt;
        setCaption(item);
      };

      const openAt = (i) => {
        if (!items.length) return;

        index = normalizeIndex(i);
        isOpen = true;

        previousBodyOverflow = document.body.style.overflow;
        document.body.style.overflow = 'hidden';

        outer.classList.remove('ril__outer--hidden');
        outer.classList.add('ril__outer--open');
        outer.setAttribute('aria-hidden', 'false');

        updateNavVisibility();
        render();

        try {
          closeBtn.focus({ preventScroll: true });
        } catch {
          // ignore
        }
      };

      const close = () => {
        if (!isOpen) return;
        isOpen = false;

        outer.classList.add('ril__outer--hidden');
        outer.classList.remove('ril__outer--open');
        outer.setAttribute('aria-hidden', 'true');

        document.body.style.overflow = previousBodyOverflow;

        imgEl.src = '';
        imgEl.alt = '';
        captionContentEl.textContent = '';
        captionEl.classList.add('ril__caption--hidden');
      };

      const next = () => {
        if (!isOpen || !items.length) return;
        index = normalizeIndex(index + 1);
        render();
      };

      const prev = () => {
        if (!isOpen || !items.length) return;
        index = normalizeIndex(index - 1);
        render();
      };

      const shouldIgnoreClick = (event) => {
        if (!event) return false;
        if (event.defaultPrevented) return true;
        if (event.button !== 0) return true;
        if (event.metaKey || event.ctrlKey || event.shiftKey || event.altKey) return true;
        return false;
      };

      document.addEventListener(
        'click',
        (event) => {
          const a = event.target && event.target.closest && event.target.closest('a[data-lightbox-index]');
          if (!a) return;
          if (shouldIgnoreClick(event)) return;

          const raw = a.getAttribute('data-lightbox-index') || '0';
          const i = Number.parseInt(raw, 10);
          if (Number.isNaN(i)) return;

          event.preventDefault();
          openAt(i);
        },
        { capture: true }
      );

      closeBtn.addEventListener('click', close);
      backdrop.addEventListener('click', close);
      prevBtn.addEventListener('click', prev);
      nextBtn.addEventListener('click', next);

      document.addEventListener('keydown', (event) => {
        if (!isOpen) return;

        if (event.key === 'Escape') {
          event.preventDefault();
          close();
          return;
        }

        if (event.key === 'ArrowLeft') {
          event.preventDefault();
          prev();
          return;
        }

        if (event.key === 'ArrowRight') {
          event.preventDefault();
          next();
        }
      });

      updateNavVisibility();
    }
  })();
</script>
